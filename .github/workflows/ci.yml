name: CI

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main]

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    name: Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libportaudio2 \
            libportaudiocpp0 \
            portaudio19-dev \
            ffmpeg \
            libsndfile1 \
            libegl1 \
            libxkbcommon0 \
            libxcb-cursor0

      - name: Install Python dependencies
        working-directory: transcription-app
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist

      - name: Run tests
        working-directory: transcription-app
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing -m "not slow and not integration"

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: transcription-app/coverage.xml
          fail_ci_if_error: false

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: Run Ruff (linting)
        working-directory: transcription-app
        run: |
          ruff check src/ --output-format=github || true

      - name: Run Ruff (formatting check)
        working-directory: transcription-app
        run: |
          ruff format --check src/ || true

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [test, lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libportaudio2 \
            portaudio19-dev \
            ffmpeg \
            libsndfile1

      - name: Install dependencies
        working-directory: transcription-app
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check imports
        working-directory: transcription-app
        run: |
          python -c "from src.core.transcriber import Transcriber; print('Transcriber OK')"
          python -c "from src.core.diarizer import Diarizer; print('Diarizer OK')"
          python -c "from src.core.audio_processor import AudioProcessor; print('AudioProcessor OK')"
          python -c "from src.utils.config import get_config; print('Config OK')"
